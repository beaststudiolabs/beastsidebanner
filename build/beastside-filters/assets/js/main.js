import{S as e,P as t,W as s,a as i,A as r,b as n,c as a,H as o,D as h,d as c,e as l,C as d,f as u,B as m,M as p,g,T as f,h as v,i as w,L as y,j as T,F as R,k as S,V as E,l as A,m as b,n as x,o as C,I as M,Q as L,p as k,O as P,q as _,r as I,s as O,t as D,u as F,N,v as B,w as U,x as H,y as j,R as z,z as G,E as K,G as V,J as X,K as Y,U as q,X as W,Y as Q,Z,_ as $,$ as J,a0 as ee,a1 as te,a2 as se,a3 as ie,a4 as re,a5 as ne,a6 as ae,a7 as oe,a8 as he,a9 as ce,aa as le,ab as de,ac as ue,ad as me,ae as pe,af as ge,ag as fe,ah as ve,ai as we,aj as ye,ak as Te,al as Re,am as Se}from"./three-vendor.js";import{f as Ee}from"./mediapipe-vendor.js";const Ae=new class{constructor(){this.deviceTier=null,this.settings=null,this.detect()}detect(){const e=this.detectDeviceTier();this.deviceTier=e,this.settings=this.getSettingsForTier(e)}detectDeviceTier(){const e=navigator.hardwareConcurrency||2,t=navigator.deviceMemory||4;let s=0;return s+=e>=8?3:e>=4?2:1,s+=t>=8?3:t>=4?2:1,/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)&&(s-=1),window.screen.width*window.screen.height<2073600&&(s+=1),s>=6?"high":s>=4?"medium":"low"}getSettingsForTier(e){return{high:{pixelRatio:Math.min(window.devicePixelRatio,2),targetFPS:60,shadowsEnabled:!1,antialiasing:!0,faceMeshDetail:"high",videoResolution:{width:1280,height:720},recordingQuality:"high",preloadAllCharacters:!0,enableBloom:!1},medium:{pixelRatio:1.5,targetFPS:30,shadowsEnabled:!1,antialiasing:!0,faceMeshDetail:"medium",videoResolution:{width:1280,height:720},recordingQuality:"medium",preloadAllCharacters:!1,enableBloom:!1},low:{pixelRatio:1,targetFPS:30,shadowsEnabled:!1,antialiasing:!1,faceMeshDetail:"low",videoResolution:{width:640,height:480},recordingQuality:"low",preloadAllCharacters:!1,enableBloom:!1}}[e]}getSettings(){return this.settings}getDeviceTier(){return this.deviceTier}isLowEnd(){return"low"===this.deviceTier}isHighEnd(){return"high"===this.deviceTier}getPixelRatio(){return this.settings.pixelRatio}getTargetFPS(){return this.settings.targetFPS}getVideoResolution(){return this.settings.videoResolution}shouldPreloadAllCharacters(){return this.settings.preloadAllCharacters}};class be{constructor(e){this.videoElement=e,this.stream=null,this.isActive=!1,this.perfSettings=Ae.getSettings()}async start(){try{const{width:e,height:t}=this.perfSettings.videoResolution,s={video:{facingMode:"user",width:{ideal:e},height:{ideal:t},frameRate:{ideal:30,max:60}},audio:!1};this.stream=await navigator.mediaDevices.getUserMedia(s),this.videoElement.srcObject=this.stream,await this.waitForVideoReady(),this.isActive=!0}catch(e){throw e}}waitForVideoReady(){return new Promise((e,t)=>{if(this.videoElement.readyState>=2)return void e();const s=()=>{this.videoElement.removeEventListener("loadeddata",s),e()},i=e=>{this.videoElement.removeEventListener("error",i),t(e)};this.videoElement.addEventListener("loadeddata",s),this.videoElement.addEventListener("error",i)})}stop(){this.stream&&(this.stream.getTracks().forEach(e=>{e.stop()}),this.videoElement.srcObject=null,this.stream=null,this.isActive=!1)}pause(){this.stream&&this.stream.getTracks().forEach(e=>{e.enabled=!1})}resume(){this.stream&&this.stream.getTracks().forEach(e=>{e.enabled=!0})}getVideoDimensions(){return{width:this.videoElement.videoWidth,height:this.videoElement.videoHeight}}}class xe{constructor(e,t){this.canvas=e,this.events=t,this.scene=null,this.camera=null,this.renderer=null,this.animationId=null,this.isRunning=!1,this.perfSettings=Ae.getSettings(),this.initialize()}initialize(){this.scene=new e;const a=window.innerWidth/window.innerHeight;this.camera=new t(50,a,.1,1e3),this.camera.position.z=3,this.renderer=new s({canvas:this.canvas,alpha:!0,antialias:this.perfSettings.antialiasing,preserveDrawingBuffer:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(this.perfSettings.pixelRatio),this.renderer.setClearColor(0,0),this.renderer.outputColorSpace=i,this.renderer.toneMapping=r,this.renderer.toneMappingExposure=.7,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=n,this.setupLighting(),this.setupEnvironment(),window.addEventListener("resize",this.onWindowResize.bind(this))}setupLighting(){this.lightingConfig={ambient:.4,hemisphere:.3,keyLight:1.5,fillLight:.5,rimLight:.4,faceLight:.4};const e=new a(16777215,this.lightingConfig.ambient);this.scene.add(e);const t=new o(16772829,526368,this.lightingConfig.hemisphere);this.scene.add(t);const s=new h(16777215,this.lightingConfig.keyLight);s.position.set(2,3,4),s.castShadow=!0,s.shadow.mapSize.width=1024,s.shadow.mapSize.height=1024,s.shadow.camera.near=.1,s.shadow.camera.far=20,s.shadow.camera.left=-5,s.shadow.camera.right=5,s.shadow.camera.top=5,s.shadow.camera.bottom=-5,s.shadow.bias=-.001,s.shadow.radius=4,this.scene.add(s);const i=new h(11193599,this.lightingConfig.fillLight);i.position.set(-2,1,2),this.scene.add(i);const r=new h(16777198,this.lightingConfig.rimLight);r.position.set(0,2,-3),this.scene.add(r);const n=new c(16775408,this.lightingConfig.faceLight,15);n.position.set(0,0,4),this.scene.add(n),this.lights={ambient:e,hemisphere:t,key:s,fill:i,rim:r,face:n}}updateLight(e,t){this.lights&&this.lights[e]&&(this.lights[e].intensity=t,this.lightingConfig["key"===e?"keyLight":"face"===e?"faceLight":e]=t)}updateAllLighting(e){void 0!==e.ambient&&(this.lights.ambient.intensity=e.ambient),void 0!==e.hemisphere&&(this.lights.hemisphere.intensity=e.hemisphere),void 0!==e.keyLight&&(this.lights.key.intensity=e.keyLight),void 0!==e.fillLight&&(this.lights.fill.intensity=e.fillLight),void 0!==e.rimLight&&(this.lights.rim.intensity=e.rimLight),void 0!==e.faceLight&&(this.lights.face.intensity=e.faceLight),Object.assign(this.lightingConfig,e)}setupEnvironment(){const t=new l(this.renderer);t.compileEquirectangularShader();const s=new e,i=new d(16777215),r=new d(8947865),n=new u({uniforms:{topColor:{value:i},bottomColor:{value:r}},vertexShader:"\n                varying vec3 vWorldPosition;\n                void main() {\n                    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n                    vWorldPosition = worldPosition.xyz;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                }\n            ",fragmentShader:"\n                uniform vec3 topColor;\n                uniform vec3 bottomColor;\n                varying vec3 vWorldPosition;\n                void main() {\n                    float h = normalize(vWorldPosition).y * 0.5 + 0.5;\n                    gl_FragColor = vec4(mix(bottomColor, topColor, h), 1.0);\n                }\n            ",side:m}),a=new p(new g(100,32,32),n);s.add(a);const o=t.fromScene(s,.04).texture;this.scene.environment=o,t.dispose(),a.geometry.dispose(),n.dispose()}setLightIntensity(e,t){this.lights[e]&&(this.lights[e].intensity=t)}setExposure(e){this.renderer.toneMappingExposure=e}start(){this.isRunning||(this.isRunning=!0,this.animate())}stop(){this.isRunning&&(this.isRunning=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null))}animate(){this.isRunning&&(this.animationId=requestAnimationFrame(this.animate.bind(this)),this.renderer.render(this.scene,this.camera))}onWindowResize(){const e=window.innerWidth,t=window.innerHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}dispose(){this.stop(),this.renderer&&this.renderer.dispose(),window.removeEventListener("resize",this.onWindowResize.bind(this))}}class Ce{constructor(){this.landmarks={leftEyeUpper:[159,145,158],leftEyeLower:[145,133,173],leftEyeLeft:33,leftEyeRight:133,rightEyeUpper:[386,374,385],rightEyeLower:[374,362,398],rightEyeLeft:362,rightEyeRight:263,mouthUpperInner:[13,312,311,310,415,308,324,318,14],mouthLowerInner:[13,82,81,80,191,78,95,88,14],mouthLeft:61,mouthRight:291,jawBottom:152,jawLeft:234,jawRight:454,browInnerLeft:107,browInnerRight:336,browOuterLeft:70,browOuterRight:300,browMidLeft:105,browMidRight:334,noseTip:1,noseBottom:168},this.baseline={leftEyeHeight:.008,rightEyeHeight:.012,mouthHeight:.01,mouthWidth:.15,faceHeight:.35},this.sensitivity={eyeBlinkLeft:.8,eyeBlinkRight:.8,eyeWideLeft:.5,eyeWideRight:1,browInnerUp:25,browOuterUp:25,browDown:20,mouthSmile:10,mouthFrown:10,mouthStretch:3,mouthPucker:3,mouthShift:20,jawOpen:3,jawShift:20}}calculateBlendshapes(e){if(!e||e.length<468)return this.getDefaultBlendshapes();const t={};return Object.assign(t,this.calculateEyeBlendshapes(e)),Object.assign(t,this.calculateMouthBlendshapes(e)),Object.assign(t,this.calculateJawBlendshapes(e)),Object.assign(t,this.calculateBrowBlendshapes(e)),t}getFixedBaseline(){return{leftEyeHeight:.002,rightEyeHeight:.012,mouthHeight:.01,mouthWidth:.15,faceHeight:.35}}calculateEyeBlendshapes(e){const t=this.getAverageEyeHeight(e,[160,159,158],[144,145,153]),s=this.getAverageEyeHeight(e,[385,386,387],[373,374,380]),i=t/this.baseline.leftEyeHeight,r=s/this.baseline.rightEyeHeight,n=Math.max(0,(1-i)*this.sensitivity.eyeBlinkLeft),a=Math.max(0,(1-r)*this.sensitivity.eyeBlinkRight),o=Math.max(0,(i-1)*this.sensitivity.eyeWideLeft),h=Math.max(0,(r-1)*this.sensitivity.eyeWideRight);return{eyeBlinkLeft:this.clamp(n,0,1),eyeBlinkRight:this.clamp(a,0,1),eyeWideLeft:this.clamp(o,0,1),eyeWideRight:this.clamp(h,0,1),eyeLookUpLeft:0,eyeLookUpRight:0,eyeLookDownLeft:0,eyeLookDownRight:0}}calculateMouthBlendshapes(e){const t=this.getVerticalDistance(e,13,14),s=this.getHorizontalDistance(e,61,291),i=Math.min(t/(this.baseline.mouthHeight*this.sensitivity.jawOpen),1),r=e[61],n=e[291],a=e[13],o=e[2],h=a.y-r.y,c=a.y-n.y,l=this.clamp(h*this.sensitivity.mouthSmile,0,1),d=this.clamp(c*this.sensitivity.mouthSmile,0,1),u=this.clamp(-h*this.sensitivity.mouthFrown,0,1),m=this.clamp(-c*this.sensitivity.mouthFrown,0,1),p=s/this.baseline.mouthWidth,g=this.clamp((p-1)*this.sensitivity.mouthStretch,0,1),f=g,v=this.clamp((1-p)*this.sensitivity.mouthPucker,0,1),w=((r.x+n.x)/2-o.x)*this.sensitivity.mouthShift,y=this.clamp(-w,0,1),T=this.clamp(w,0,1);return{jawOpen:this.clamp(i,0,1),mouthSmileLeft:l,mouthSmileRight:d,mouthFrownLeft:u,mouthFrownRight:m,mouthStretchLeft:g,mouthStretchRight:f,mouthPucker:v,mouthLeft:y,mouthRight:T}}calculateJawBlendshapes(e){const t=e[152],s=e[168],i=t.x-s.x;return{jawLeft:this.clamp(-i*this.sensitivity.jawShift,0,1),jawRight:this.clamp(i*this.sensitivity.jawShift,0,1),jawForward:0}}calculateBrowBlendshapes(e){const t=e[107],s=e[336],i=e[70],r=e[300],n=e[6],a=(e[10].y+n.y)/2,o=(a-t.y+(a-s.y))*this.sensitivity.browInnerUp,h=a-i.y,c=a-r.y,l=Math.max((t.y-a)*this.sensitivity.browDown,0),d=Math.max((s.y-a)*this.sensitivity.browDown,0);return{browInnerUp:this.clamp(o,0,1),browOuterUpLeft:this.clamp(h*this.sensitivity.browOuterUp,0,1),browOuterUpRight:this.clamp(c*this.sensitivity.browOuterUp,0,1),browDownLeft:this.clamp(l,0,1),browDownRight:this.clamp(d,0,1)}}getAverageEyeHeight(e,t,s){let i=0;const r=Math.min(t.length,s.length);for(let n=0;n<r;n++){const r=e[t[n]],a=e[s[n]];i+=Math.abs(r.y-a.y)}return i/r}getVerticalDistance(e,t,s){const i=e[t],r=e[s];return Math.abs(i.y-r.y)}getHorizontalDistance(e,t,s){const i=e[t],r=e[s];return Math.abs(i.x-r.x)}clamp(e,t,s){return Math.min(Math.max(e,t),s)}getDefaultBlendshapes(){return{eyeBlinkLeft:0,eyeBlinkRight:0,eyeWideLeft:0,eyeWideRight:0,eyeLookUpLeft:0,eyeLookUpRight:0,eyeLookDownLeft:0,eyeLookDownRight:0,jawOpen:0,mouthSmileLeft:0,mouthSmileRight:0,mouthFrownLeft:0,mouthFrownRight:0,mouthStretchLeft:0,mouthStretchRight:0,mouthPucker:0,mouthLeft:0,mouthRight:0,jawLeft:0,jawRight:0,jawForward:0,browInnerUp:0,browOuterUpLeft:0,browOuterUpRight:0,browDownLeft:0,browDownRight:0}}resetBaseline(){this.baseline=this.getFixedBaseline()}}class Me{constructor(e,t){this.videoElement=e,this.eventEmitter=t,this.faceMesh=null,this.blendshapeMapper=new Ce,this.isInitialized=!1,this.isTracking=!1,this.lastFrameTime=0,this.frameCount=0,this.fps=0,this.faceDetected=!1,this.currentLandmarks=null,this.currentBlendshapes=null}async initialize(){try{this.faceMesh=new Ee.FaceMesh({locateFile:e=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${e}`}),this.faceMesh.setOptions({maxNumFaces:1,refineLandmarks:!0,minDetectionConfidence:.5,minTrackingConfidence:.5}),this.faceMesh.onResults(this.onResults.bind(this)),this.isInitialized=!0}catch(e){throw e}}async start(){this.isInitialized||await this.initialize(),this.isTracking=!0,this.processFrame()}stop(){this.isTracking=!1}async processFrame(){if(this.isTracking&&!(!this.videoElement.readyState>=2))try{await this.faceMesh.send({image:this.videoElement}),this.isTracking&&requestAnimationFrame(()=>this.processFrame())}catch(e){}}onResults(e){if(this.updateFPS(),e.multiFaceLandmarks&&e.multiFaceLandmarks.length>0){this.faceDetected||(this.faceDetected=!0,this.eventEmitter.emit("faceDetected",{detected:!0})),this.currentLandmarks=e.multiFaceLandmarks[0],this.currentBlendshapes=this.blendshapeMapper.calculateBlendshapes(this.currentLandmarks);const t=this.calculateFaceTransform(this.currentLandmarks);this.eventEmitter.emit("faceTracked",{landmarks:this.currentLandmarks,blendshapes:this.currentBlendshapes,transform:t,fps:this.fps})}else this.faceDetected&&(this.faceDetected=!1,this.eventEmitter.emit("faceDetected",{detected:!1}))}calculateFaceTransform(e){const t=e[1],s=e[6],i=e[152],r=e[33],n=e[263],a=e[133],o=e[362],h=e[61],c=e[291],l=e[10],d={x:2*(s.x-.5),y:2*-(s.y-.5),z:s.z||0},u=10*Math.sqrt(Math.pow(n.x-r.x,2)+Math.pow(n.y-r.y,2)+Math.pow((n.z||0)-(r.z||0),2)),m=(r.z+a.z+h.z)/3-(n.z+o.z+c.z)/3,p=(r.x+n.x)/2,g=-(4*m+3*(t.x-p));return{position:d,rotation:{pitch:-(2*((s.y-l.y)/(i.y-s.y+.001)-.8)+5*((t.z||0)-(s.z||0))),yaw:g,roll:Math.atan2(n.y-r.y,n.x-r.x)},scale:u}}updateFPS(){const e=performance.now();if(this.frameCount++,0===this.lastFrameTime)return void(this.lastFrameTime=e);const t=e-this.lastFrameTime;t>=1e3&&(this.fps=Math.round(1e3*this.frameCount/t),this.frameCount=0,this.lastFrameTime=e,this.eventEmitter.emit("fpsUpdate",{fps:this.fps}))}getTrackingState(){return{isTracking:this.isTracking,faceDetected:this.faceDetected,fps:this.fps,landmarks:this.currentLandmarks,blendshapes:this.currentBlendshapes}}reset(){this.blendshapeMapper.resetBaseline(),this.faceDetected=!1,this.currentLandmarks=null,this.currentBlendshapes=null}}function Le(e,t){if(t===f)return e;if(t===v||t===w){let s=e.getIndex();if(null===s){const t=[],i=e.getAttribute("position");if(void 0===i)return e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const i=s.count-2,r=[];if(t===v)for(let e=1;e<=i;e++)r.push(s.getX(0)),r.push(s.getX(e)),r.push(s.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(r.push(s.getX(e)),r.push(s.getX(e+1)),r.push(s.getX(e+2))):(r.push(s.getX(e+2)),r.push(s.getX(e+1)),r.push(s.getX(e)));r.length;const n=e.clone();return n.setIndex(r),n.clearGroups(),n}return e}class ke extends y{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new Fe(e)}),this.register(function(e){return new Ve(e)}),this.register(function(e){return new Xe(e)}),this.register(function(e){return new Ye(e)}),this.register(function(e){return new Be(e)}),this.register(function(e){return new Ue(e)}),this.register(function(e){return new He(e)}),this.register(function(e){return new je(e)}),this.register(function(e){return new De(e)}),this.register(function(e){return new ze(e)}),this.register(function(e){return new Ne(e)}),this.register(function(e){return new Ke(e)}),this.register(function(e){return new Ge(e)}),this.register(function(e){return new Ie(e)}),this.register(function(e){return new qe(e)}),this.register(function(e){return new We(e)})}load(e,t,s,i){const r=this;let n;if(""!==this.resourcePath)n=this.resourcePath;else if(""!==this.path){const t=T.extractUrlBase(e);n=T.resolveURL(t,this.path)}else n=T.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){i&&i(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new R(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(s){try{r.parse(s,n,function(s){t(s),r.manager.itemEnd(e)},a)}catch(i){a(i)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let r;const n={},a={},o=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===Qe){try{n[_e.KHR_BINARY_GLTF]=new Je(e)}catch(c){return void(i&&i(c))}r=JSON.parse(n[_e.KHR_BINARY_GLTF].content)}else r=JSON.parse(o.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const h=new bt(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});h.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const e=this.pluginCallbacks[l](h);e.name,a[e.name]=e,n[e.name]=!0}if(r.extensionsUsed)for(let l=0;l<r.extensionsUsed.length;++l){const e=r.extensionsUsed[l],t=r.extensionsRequired||[];switch(e){case _e.KHR_MATERIALS_UNLIT:n[e]=new Oe;break;case _e.KHR_DRACO_MESH_COMPRESSION:n[e]=new et(r,this.dracoLoader);break;case _e.KHR_TEXTURE_TRANSFORM:n[e]=new tt;break;case _e.KHR_MESH_QUANTIZATION:n[e]=new st;break;default:t.indexOf(e)>=0&&a[e]}}h.setExtensions(n),h.setPlugins(a),h.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,r){s.parse(e,t,i,r)})}}function Pe(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const _e={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Ie{constructor(e){this.parser=e,this.name=_e.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const r=t.json,n=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let a;const o=new d(16777215);void 0!==n.color&&o.setRGB(n.color[0],n.color[1],n.color[2],A);const l=void 0!==n.range?n.range:0;switch(n.type){case"directional":a=new h(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new c(o),a.distance=l;break;case"spot":a=new b(o),a.distance=l,n.spot=n.spot||{},n.spot.innerConeAngle=void 0!==n.spot.innerConeAngle?n.spot.innerConeAngle:0,n.spot.outerConeAngle=void 0!==n.spot.outerConeAngle?n.spot.outerConeAngle:Math.PI/4,a.angle=n.spot.outerConeAngle,a.penumbra=1-n.spot.innerConeAngle/n.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+n.type)}return a.position.set(0,0,0),a.decay=2,yt(a,n),void 0!==n.intensity&&(a.intensity=n.intensity),a.name=t.createUniqueName(n.name||"light_"+e),i=Promise.resolve(a),t.cache.add(s,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,i=s.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then(function(e){return s._getNodeRef(t.cache,r,e)})}}class Oe{constructor(){this.name=_e.KHR_MATERIALS_UNLIT}getMaterialType(){return Q}extendParams(e,t,s){const r=[];e.color=new d(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const t=n.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],A),e.opacity=t[3]}void 0!==n.baseColorTexture&&r.push(s.assignTexture(e,"map",n.baseColorTexture,i))}return Promise.all(r)}}class De{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class Fe{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];if(void 0!==n.clearcoatFactor&&(t.clearcoat=n.clearcoatFactor),void 0!==n.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",n.clearcoatTexture)),void 0!==n.clearcoatRoughnessFactor&&(t.clearcoatRoughness=n.clearcoatRoughnessFactor),void 0!==n.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),void 0!==n.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",n.clearcoatNormalTexture)),void 0!==n.clearcoatNormalTexture.scale)){const e=n.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new E(e,e)}return Promise.all(r)}}class Ne{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.iridescenceFactor&&(t.iridescence=n.iridescenceFactor),void 0!==n.iridescenceTexture&&r.push(s.assignTexture(t,"iridescenceMap",n.iridescenceTexture)),void 0!==n.iridescenceIor&&(t.iridescenceIOR=n.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==n.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),void 0!==n.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),void 0!==n.iridescenceThicknessTexture&&r.push(s.assignTexture(t,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(r)}}class Be{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,r=s.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new d(0,0,0),t.sheenRoughness=0,t.sheen=1;const a=r.extensions[this.name];if(void 0!==a.sheenColorFactor){const e=a.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],A)}return void 0!==a.sheenRoughnessFactor&&(t.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&n.push(s.assignTexture(t,"sheenColorMap",a.sheenColorTexture,i)),void 0!==a.sheenRoughnessTexture&&n.push(s.assignTexture(t,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(n)}}class Ue{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.transmissionFactor&&(t.transmission=n.transmissionFactor),void 0!==n.transmissionTexture&&r.push(s.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(r)}}class He{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];t.thickness=void 0!==n.thicknessFactor?n.thicknessFactor:0,void 0!==n.thicknessTexture&&r.push(s.assignTexture(t,"thicknessMap",n.thicknessTexture)),t.attenuationDistance=n.attenuationDistance||1/0;const a=n.attenuationColor||[1,1,1];return t.attenuationColor=(new d).setRGB(a[0],a[1],a[2],A),Promise.all(r)}}class je{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class ze{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,r=s.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const n=[],a=r.extensions[this.name];t.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&n.push(s.assignTexture(t,"specularIntensityMap",a.specularTexture));const o=a.specularColorFactor||[1,1,1];return t.specularColor=(new d).setRGB(o[0],o[1],o[2],A),void 0!==a.specularColorTexture&&n.push(s.assignTexture(t,"specularColorMap",a.specularColorTexture,i)),Promise.all(n)}}class Ge{constructor(e){this.parser=e,this.name=_e.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return t.bumpScale=void 0!==n.bumpFactor?n.bumpFactor:1,void 0!==n.bumpTexture&&r.push(s.assignTexture(t,"bumpMap",n.bumpTexture)),Promise.all(r)}}class Ke{constructor(e){this.parser=e,this.name=_e.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?S:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.anisotropyStrength&&(t.anisotropy=n.anisotropyStrength),void 0!==n.anisotropyRotation&&(t.anisotropyRotation=n.anisotropyRotation),void 0!==n.anisotropyTexture&&r.push(s.assignTexture(t,"anisotropyMap",n.anisotropyTexture)),Promise.all(r)}}class Ve{constructor(e){this.parser=e,this.name=_e.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],n=t.options.ktx2Loader;if(!n){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,n)}}class Xe{constructor(e){this.parser=e,this.name=_e.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const n=r.extensions[t],a=i.images[n.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then(function(r){if(r)return s.loadTextureImage(e,n.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class Ye{constructor(e){this.parser=e,this.name=_e.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const n=r.extensions[t],a=i.images[n.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then(function(r){if(r)return s.loadTextureImage(e,n.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class qe{constructor(e){this.name=_e.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(t){const s=e.byteOffset||0,i=e.byteLength||0,n=e.count,a=e.byteStride,o=new Uint8Array(t,s,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(n,a,o,e.mode,e.filter).then(function(e){return e.buffer}):r.ready.then(function(){const t=new ArrayBuffer(n*a);return r.decodeGltfBuffer(new Uint8Array(t),n,a,o,e.mode,e.filter),t})})}return null}}class We{constructor(e){this.name=_e.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const i=t.meshes[s.mesh];for(const o of i.primitives)if(o.mode!==at.TRIANGLES&&o.mode!==at.TRIANGLE_STRIP&&o.mode!==at.TRIANGLE_FAN&&void 0!==o.mode)return null;const r=s.extensions[this.name].attributes,n=[],a={};for(const o in r)n.push(this.parser.getDependency("accessor",r[o]).then(e=>(a[o]=e,a[o])));return n.length<1?null:(n.push(this.parser.createNodeMesh(e)),Promise.all(n).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],i=e[0].count,r=[];for(const n of s){const e=new x,t=new C,s=new L,o=new C(1,1,1),h=new M(n.geometry,n.material,i);for(let r=0;r<i;r++)a.TRANSLATION&&t.fromBufferAttribute(a.TRANSLATION,r),a.ROTATION&&s.fromBufferAttribute(a.ROTATION,r),a.SCALE&&o.fromBufferAttribute(a.SCALE,r),h.setMatrixAt(r,e.compose(t,s,o));for(const i in a)if("_COLOR_0"===i){const e=a[i];h.instanceColor=new k(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==i&&"ROTATION"!==i&&"SCALE"!==i&&n.geometry.setAttribute(i,a[i]);P.prototype.copy.call(h,n),this.parser.assignFinalMaterial(h),r.push(h)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]}))}}const Qe="glTF",Ze=1313821514,$e=5130562;class Je{constructor(e){this.name=_e.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Qe)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,r=new DataView(e,12);let n=0;for(;n<i;){const t=r.getUint32(n,!0);n+=4;const i=r.getUint32(n,!0);if(n+=4,i===Ze){const i=new Uint8Array(e,12+n,t);this.content=s.decode(i)}else if(i===$e){const s=12+n;this.body=e.slice(s,s+t)}n+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class et{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=_e.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,r=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,a={},o={},h={};for(const c in n){const e=dt[c]||c.toLowerCase();a[e]=n[c]}for(const c in e.attributes){const t=dt[c]||c.toLowerCase();if(void 0!==n[c]){const i=s.accessors[e.attributes[c]],r=ot[i.componentType];h[t]=r.name,o[t]=!0===i.normalized}}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t,s){i.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],i=o[t];void 0!==i&&(s.normalized=i)}t(e)},a,h,A,s)})})}}class tt{constructor(){this.name=_e.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class st{constructor(){this.name=_e.KHR_MESH_QUANTIZATION}}class it extends ye{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let n=0;n!==i;n++)t[n]=s[r+n];return t}interpolate_(e,t,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=2*a,h=3*a,c=i-t,l=(s-t)/c,d=l*l,u=d*l,m=e*h,p=m-h,g=-2*u+3*d,f=u-d,v=1-g,w=f-d+l;for(let y=0;y!==a;y++){const e=n[p+y+a],t=n[p+y+o]*c,s=n[m+y+a],i=n[m+y]*c;r[y]=v*e+w*t+g*s+f*i}return r}}const rt=new L;class nt extends it{interpolate_(e,t,s,i){const r=super.interpolate_(e,t,s,i);return rt.fromArray(r).normalize().toArray(r),r}}const at={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ot={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ht={9728:j,9729:H,9984:U,9985:B,9986:N,9987:F},ct={33071:K,33648:G,10497:z},lt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},dt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ut={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},mt={CUBICSPLINE:void 0,LINEAR:de,STEP:le},pt="OPAQUE",gt="MASK",ft="BLEND";function vt(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new q({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:we})),e.DefaultMaterial}function wt(e,t,s){for(const i in s.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=s.extensions[i])}function yt(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function Tt(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,i=t.weights.length;s<i;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,i=s.length;t<i;t++)e.morphTargetDictionary[s[t]]=t}}}function Rt(e){let t;const s=e.extensions&&e.extensions[_e.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+St(s.attributes):e.indices+":"+St(e.attributes)+":"+e.mode,void 0!==e.targets)for(let i=0,r=e.targets.length;i<r;i++)t+=":"+St(e.targets[i]);return t}function St(e){let t="";const s=Object.keys(e).sort();for(let i=0,r=s.length;i<r;i++)t+=s[i]+":"+e[s[i]]+";";return t}function Et(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const At=new x;class bt{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Pe,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=!1,r=-1;"undefined"!=typeof navigator&&(s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=navigator.userAgent.indexOf("Firefox")>-1,r=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s||i&&r<98?this.textureLoader=new _(this.options.manager):this.textureLoader=new I(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new R(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const n={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:s,userData:{}};return wt(r,n,i),yt(n,i),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(n)})).then(function(){e(n)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,r=t.length;i<r;i++){const s=t[i].joints;for(let t=0,i=s.length;t<i;t++)e[s[t]].isBone=!0}for(let i=0,r=e.length;i<r;i++){const t=e[i];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),r=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[i,n]of e.children.entries())r(n,t.children[i])};return r(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":i=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e)}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map(function(t,i){return s.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[_e.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(e,r){s.load(T.resolveURL(t.uri,i.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+s)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){const e=lt[i.type],t=ot[i.componentType],s=!0===i.normalized,r=new t(i.count*e);return Promise.resolve(new O(r,e,s))}const r=[];return void 0!==i.bufferView?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),void 0!==i.sparse&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then(function(e){const r=e[0],n=lt[i.type],a=ot[i.componentType],o=a.BYTES_PER_ELEMENT,h=o*n,c=i.byteOffset||0,l=void 0!==i.bufferView?s.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;let u,m;if(l&&l!==h){const e=Math.floor(c/l),s="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let h=t.cache.get(s);h||(u=new a(r,e*l,i.count*l/o),h=new D(u,l/o),t.cache.add(s,h)),m=new ue(h,n,c%l/o,d)}else u=null===r?new a(i.count*n):new a(r,c,i.count*n),m=new O(u,n,d);if(void 0!==i.sparse){const t=lt.SCALAR,s=ot[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,h=i.sparse.values.byteOffset||0,c=new s(e[1],o,i.sparse.count*t),l=new a(e[2],h,i.sparse.count*n);null!==r&&(m=new O(m.array.slice(),m.itemSize,m.normalized));for(let e=0,i=c.length;e<i;e++){const t=c[e];if(m.setX(t,l[e*n]),n>=2&&m.setY(t,l[e*n+1]),n>=3&&m.setZ(t,l[e*n+2]),n>=4&&m.setW(t,l[e*n+3]),n>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(e){const t=this.json,s=this.options,i=t.textures[e].source,r=t.images[i];let n=this.textureLoader;if(r.uri){const e=s.manager.getHandler(r.uri);null!==e&&(n=e)}return this.loadTextureImage(e,i,n)}loadTextureImage(e,t,s){const i=this,r=this.json,n=r.textures[e],a=r.images[t],o=(a.uri||a.bufferView)+":"+n.sampler;if(this.textureCache[o])return this.textureCache[o];const h=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=n.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const s=(r.samplers||{})[n.sampler]||{};return t.magFilter=ht[s.magFilter]||H,t.minFilter=ht[s.minFilter]||F,t.wrapS=ct[s.wrapS]||z,t.wrapT=ct[s.wrapT]||z,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=h,h}loadImageSource(e,t){const s=this,i=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const n=i.images[e],a=self.URL||self.webkitURL;let o=n.uri||"",h=!1;if(void 0!==n.bufferView)o=s.getDependency("bufferView",n.bufferView).then(function(e){h=!0;const t=new Blob([e],{type:n.mimeType});return o=a.createObjectURL(t),o});else if(void 0===n.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(o).then(function(e){return new Promise(function(s,i){let n=s;!0===t.isImageBitmapLoader&&(n=function(e){const t=new me(e);t.needsUpdate=!0,s(t)}),t.load(T.resolveURL(e,r.path),n,void 0,i)})}).then(function(e){var t;return!0===h&&a.revokeObjectURL(o),e.userData.mimeType=n.mimeType||((t=n.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e}).catch(function(e){throw e});return this.sourceCache[e]=c,c}assignTexture(e,t,s,i){const r=this;return this.getDependency("texture",s.index).then(function(n){if(!n)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((n=n.clone()).channel=s.texCoord),r.extensions[_e.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[_e.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(n);n=r.extensions[_e.KHR_TEXTURE_TRANSFORM].extendTexture(n,e),r.associations.set(n,t)}}return void 0!==i&&(n.colorSpace=i),e[t]=n,n})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,n=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new V,X.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Y,X.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(i||r||n){let e="ClonedMaterial:"+s.uuid+":";i&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),n&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),r&&(t.vertexColors=!0),n&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return q}loadMaterial(e){const t=this,s=this.json,r=this.extensions,n=s.materials[e];let a;const o={},h=[];if((n.extensions||{})[_e.KHR_MATERIALS_UNLIT]){const e=r[_e.KHR_MATERIALS_UNLIT];a=e.getMaterialType(),h.push(e.extendParams(o,n,t))}else{const s=n.pbrMetallicRoughness||{};if(o.color=new d(1,1,1),o.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],A),o.opacity=e[3]}void 0!==s.baseColorTexture&&h.push(t.assignTexture(o,"map",s.baseColorTexture,i)),o.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,o.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(h.push(t.assignTexture(o,"metalnessMap",s.metallicRoughnessTexture)),h.push(t.assignTexture(o,"roughnessMap",s.metallicRoughnessTexture))),a=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),h.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)})))}!0===n.doubleSided&&(o.side=W);const c=n.alphaMode||pt;if(c===ft?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,c===gt&&(o.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&a!==Q&&(h.push(t.assignTexture(o,"normalMap",n.normalTexture)),o.normalScale=new E(1,1),void 0!==n.normalTexture.scale)){const e=n.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==n.occlusionTexture&&a!==Q&&(h.push(t.assignTexture(o,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(o.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&a!==Q){const e=n.emissiveFactor;o.emissive=(new d).setRGB(e[0],e[1],e[2],A)}return void 0!==n.emissiveTexture&&a!==Q&&h.push(t.assignTexture(o,"emissiveMap",n.emissiveTexture,i)),Promise.all(h).then(function(){const s=new a(o);return n.name&&(s.name=n.name),yt(s,n),t.associations.set(s,{materials:e}),n.extensions&&wt(r,s,n),s})}createUniqueName(e){const t=Z.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function r(e){return s[_e.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return xt(s,e,t)})}const n=[];for(let a=0,o=e.length;a<o;a++){const s=e[a],o=Rt(s),h=i[o];if(h)n.push(h.promise);else{let e;e=s.extensions&&s.extensions[_e.KHR_DRACO_MESH_COMPRESSION]?r(s):xt(new $,s,t),i[o]={primitive:s,promise:e},n.push(e)}}return Promise.all(n)}loadMesh(e){const t=this,s=this.json,i=this.extensions,r=s.meshes[e],n=r.primitives,a=[];for(let o=0,h=n.length;o<h;o++){const e=void 0===n[o].material?vt(this.cache):this.getDependency("material",n[o].material);a.push(e)}return a.push(t.loadGeometries(n)),Promise.all(a).then(function(s){const a=s.slice(0,s.length-1),o=s[s.length-1],h=[];for(let l=0,d=o.length;l<d;l++){const s=o[l],c=n[l];let d;const u=a[l];if(c.mode===at.TRIANGLES||c.mode===at.TRIANGLE_STRIP||c.mode===at.TRIANGLE_FAN||void 0===c.mode)d=!0===r.isSkinnedMesh?new J(s,u):new p(s,u),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),c.mode===at.TRIANGLE_STRIP?d.geometry=Le(d.geometry,w):c.mode===at.TRIANGLE_FAN&&(d.geometry=Le(d.geometry,v));else if(c.mode===at.LINES)d=new ee(s,u);else if(c.mode===at.LINE_STRIP)d=new te(s,u);else if(c.mode===at.LINE_LOOP)d=new se(s,u);else{if(c.mode!==at.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);d=new ie(s,u)}Object.keys(d.geometry.morphAttributes).length>0&&Tt(d,r),d.name=t.createUniqueName(r.name||"mesh_"+e),yt(d,r),c.extensions&&wt(i,d,c),t.assignFinalMaterial(d),h.push(d)}for(let i=0,r=h.length;i<r;i++)t.associations.set(h[i],{meshes:e,primitives:i});if(1===h.length)return r.extensions&&wt(i,h[0],r),h[0];const c=new re;r.extensions&&wt(i,c,r),t.associations.set(c,{meshes:e});for(let e=0,t=h.length;e<t;e++)c.add(h[e]);return c})}loadCamera(e){let s;const i=this.json.cameras[e],r=i[i.type];if(r)return"perspective"===i.type?s=new t(ne.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===i.type&&(s=new ae(-r.xmag,r.xmag,r.ymag,-r.ymag,r.znear,r.zfar)),i.name&&(s.name=this.createUniqueName(i.name)),yt(s,i),Promise.resolve(s)}loadSkin(e){const t=this.json.skins[e],s=[];for(let i=0,r=t.joints.length;i<r;i++)s.push(this._loadNodeShallow(t.joints[i]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const t=e.pop(),s=e,i=[],r=[];for(let n=0,a=s.length;n<a;n++){const e=s[n];if(e){i.push(e);const s=new x;null!==t&&s.fromArray(t.array,16*n),r.push(s)}}return new oe(i,r)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],r=i.name?i.name:"animation_"+e,n=[],a=[],o=[],h=[],c=[];for(let l=0,d=i.channels.length;l<d;l++){const e=i.channels[l],t=i.samplers[e.sampler],s=e.target,r=s.node,d=void 0!==i.parameters?i.parameters[t.input]:t.input,u=void 0!==i.parameters?i.parameters[t.output]:t.output;void 0!==s.node&&(n.push(this.getDependency("node",r)),a.push(this.getDependency("accessor",d)),o.push(this.getDependency("accessor",u)),h.push(t),c.push(s))}return Promise.all([Promise.all(n),Promise.all(a),Promise.all(o),Promise.all(h),Promise.all(c)]).then(function(e){const t=e[0],i=e[1],n=e[2],a=e[3],o=e[4],h=[];for(let r=0,c=t.length;r<c;r++){const e=t[r],c=i[r],l=n[r],d=a[r],u=o[r];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const m=s._createAnimationTracks(e,c,l,d,u);if(m)for(let t=0;t<m.length;t++)h.push(m[t])}return new he(r,void 0,h)})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],i=t._loadNodeShallow(e),r=[],n=s.children||[];for(let o=0,h=n.length;o<h;o++)r.push(t.getDependency("node",n[o]));const a=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([i,Promise.all(r),a]).then(function(e){const t=e[0],s=e[1],i=e[2];null!==i&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(i,At)});for(let r=0,n=s.length;r<n;r++)t.add(s[r]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],n=r.name?i.createUniqueName(r.name):"",a=[],o=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return o&&a.push(o),void 0!==r.camera&&a.push(i.getDependency("camera",r.camera).then(function(e){return i._getNodeRef(i.cameraCache,r.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if(a=!0===r.isBone?new ce:t.length>1?new re:1===t.length?t[0]:new P,a!==t[0])for(let e=0,s=t.length;e<s;e++)a.add(t[e]);if(r.name&&(a.userData.name=r.name,a.name=n),yt(a,r),r.extensions&&wt(s,a,r),void 0!==r.matrix){const e=new x;e.fromArray(r.matrix),a.applyMatrix4(e)}else void 0!==r.translation&&a.position.fromArray(r.translation),void 0!==r.rotation&&a.quaternion.fromArray(r.rotation),void 0!==r.scale&&a.scale.fromArray(r.scale);return i.associations.has(a)||i.associations.set(a,{}),i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,r=new re;s.name&&(r.name=i.createUniqueName(s.name)),yt(r,s),s.extensions&&wt(t,r,s);const n=s.nodes||[],a=[];for(let o=0,h=n.length;o<h;o++)a.push(i.getDependency("node",n[o]));return Promise.all(a).then(function(e){for(let t=0,s=e.length;t<s;t++)r.add(e[t]);return i.associations=(e=>{const t=new Map;for(const[s,r]of i.associations)(s instanceof X||s instanceof me)&&t.set(s,r);return e.traverse(e=>{const s=i.associations.get(e);null!=s&&t.set(e,s)}),t})(r),r})}_createAnimationTracks(e,t,s,i,r){const n=[],a=e.name?e.name:e.uuid,o=[];let h;switch(ut[r.path]===ut.weights?e.traverse(function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)}):o.push(a),ut[r.path]){case ut.weights:h=ge;break;case ut.rotation:h=fe;break;case ut.position:case ut.scale:h=pe;break;default:if(1===s.itemSize)h=ge;else h=pe}const c=void 0!==i.interpolation?mt[i.interpolation]:de,l=this._getArrayFromAccessor(s);for(let d=0,u=o.length;d<u;d++){const e=new h(o[d]+"."+ut[r.path],t.array,l,c);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(e),n.push(e)}return n}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=Et(t.constructor),s=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)s[i]=t[i]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof fe?nt:it)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function xt(e,t,s){const i=t.attributes,r=[];function n(t,i){return s.getDependency("accessor",t).then(function(t){e.setAttribute(i,t)})}for(const a in i){const t=dt[a]||a.toLowerCase();t in e.attributes||r.push(n(i[a],t))}if(void 0!==t.indices&&!e.index){const i=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});r.push(i)}return ve.workingColorSpace,yt(e,t),function(e,t,s){const i=t.attributes,r=new Te;if(void 0===i.POSITION)return;{const e=s.json.accessors[i.POSITION],t=e.min,n=e.max;if(void 0===t||void 0===n)return;if(r.set(new C(t[0],t[1],t[2]),new C(n[0],n[1],n[2])),e.normalized){const t=Et(ot[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const n=t.targets;if(void 0!==n){const e=new C,t=new C;for(let i=0,r=n.length;i<r;i++){const r=n[i];if(void 0!==r.POSITION){const i=s.json.accessors[r.POSITION],n=i.min,a=i.max;if(void 0!==n&&void 0!==a){if(t.setX(Math.max(Math.abs(n[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(n[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(n[2]),Math.abs(a[2]))),i.normalized){const e=Et(ot[i.componentType]);t.multiplyScalar(e)}e.max(t)}}}r.expandByVector(e)}e.boundingBox=r;const a=new Re;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=a}(e,t,s),Promise.all(r).then(function(){return void 0!==t.targets?function(e,t,s){let i=!1,r=!1,n=!1;for(let c=0,l=t.length;c<l;c++){const e=t[c];if(void 0!==e.POSITION&&(i=!0),void 0!==e.NORMAL&&(r=!0),void 0!==e.COLOR_0&&(n=!0),i&&r&&n)break}if(!i&&!r&&!n)return Promise.resolve(e);const a=[],o=[],h=[];for(let c=0,l=t.length;c<l;c++){const l=t[c];if(i){const t=void 0!==l.POSITION?s.getDependency("accessor",l.POSITION):e.attributes.position;a.push(t)}if(r){const t=void 0!==l.NORMAL?s.getDependency("accessor",l.NORMAL):e.attributes.normal;o.push(t)}if(n){const t=void 0!==l.COLOR_0?s.getDependency("accessor",l.COLOR_0):e.attributes.color;h.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(h)]).then(function(t){const s=t[0],a=t[1],o=t[2];return i&&(e.morphAttributes.position=s),r&&(e.morphAttributes.normal=a),n&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}(e,t.targets,s):e})}class Ct{constructor(){this.size=128,this.loader=new ke,this.cache=new Map,this.renderer=new s({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(this.size,this.size),this.renderer.setPixelRatio(2),this.renderer.setClearColor(0,0),this.renderer.outputColorSpace=i,this.renderer.toneMapping=r,this.renderer.toneMappingExposure=1.2,this.scene=new e,this.camera=new t(35,1,.1,100),this.camera.position.set(0,.1,2),this.camera.lookAt(0,0,0),this.setupLighting()}setupLighting(){const t=new a(16777215,.6);this.scene.add(t);const s=new h(16777215,1.5);s.position.set(1,2,3),this.scene.add(s);const i=new h(11193599,.6);i.position.set(-1,.5,2),this.scene.add(i);const r=new h(16777198,.4);r.position.set(0,1,-2),this.scene.add(r);const n=new e,o=new u({uniforms:{topColor:{value:new d(16777215)},bottomColor:{value:new d(8947865)}},vertexShader:"\n                varying vec3 vWorldPosition;\n                void main() {\n                    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n                    vWorldPosition = worldPosition.xyz;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                }\n            ",fragmentShader:"\n                uniform vec3 topColor;\n                uniform vec3 bottomColor;\n                varying vec3 vWorldPosition;\n                void main() {\n                    float h = normalize(vWorldPosition).y * 0.5 + 0.5;\n                    gl_FragColor = vec4(mix(bottomColor, topColor, h), 1.0);\n                }\n            ",side:m}),c=new p(new g(50,32,32),o);n.add(c);const f=new l(this.renderer);f.compileEquirectangularShader();const v=f.fromScene(n,.04).texture;this.scene.environment=v,f.dispose(),c.geometry.dispose(),o.dispose()}async generateThumbnail(e){if(this.cache.has(e))return this.cache.get(e);try{const t=(await this.loadModel(e)).scene;this.clearScene();const s=(new Te).setFromObject(t),i=s.getCenter(new C),r=s.getSize(new C);t.position.x=-i.x,t.position.y=-i.y+.15*r.y,t.position.z=-i.z;const n=1.2/Math.max(r.x,.5*r.y,r.z);t.scale.setScalar(n),t.rotation.y=Math.PI,this.scene.add(t),this.renderer.render(this.scene,this.camera);const a=this.renderer.domElement.toDataURL("image/png");return this.cache.set(e,a),this.scene.remove(t),this.disposeModel(t),a}catch(t){return null}}loadModel(e){return new Promise((t,s)=>{this.loader.load(e,e=>t(e),void 0,e=>s(e))})}clearScene(){const e=[];this.scene.traverse(t=>{(t.isMesh||t.isGroup)&&(t.isLight||e.push(t))}),e.forEach(e=>{e.parent===this.scene&&this.scene.remove(e)})}disposeModel(e){e.traverse(e=>{e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()))})}async generateAllThumbnails(e){const t=new Map;for(const s of e){const e=await this.generateThumbnail(s.path);e&&t.set(s.path,e)}return t}dispose(){this.clearScene(),this.renderer.dispose(),this.cache.clear()}}class Mt{constructor(e,t){this.scene=e,this.events=t,this.loader=new ke,this.thumbnailGenerator=new Ct,this.modelsBasePath=this.getModelsBasePath(),this.characters=[{id:"char1",name:"Rafsby",path:"1.glb",loaded:!1,thumbnail:null},{id:"char2",name:"Rafsby 2",path:"1.glb",loaded:!1,thumbnail:null}],this.currentCharacterIndex=0,this.currentModel=null,this.morphTargetMeshes=[],this.isLoading=!1,this.loadingProgress=0,this.blendshapeNameMap={},this.modelConfig={scaleBase:6,scaleMultiplier:1,scaleMin:.1,scaleMax:50,scaleX:1,scaleY:1,scaleZ:1,positionScale:1,positionScaleX:1,positionScaleY:1,positionOffsetX:0,positionOffsetY:0,positionOffsetZ:-1,mirrorX:!0,baseRotationX:-.5,baseRotationY:Math.PI,baseRotationZ:0,rotationScale:1,pitchScale:1,yawScale:5,rollScale:0,pitchOffset:0,yawOffset:0,rollOffset:0,smoothing:.5,positionSmoothing:.6,rotationSmoothing:.6,scaleSmoothing:.7,blendshapeSmoothing:.75,eyeSmoothing:.8,positionDeadzone:.01,rotationDeadzone:.02,blendshapeDeadzone:.03,eyeDeadzone:.06},this.smoothedTransform={position:{x:0,y:0,z:0},rotation:{pitch:0,yaw:0,roll:0},scale:1},this.smoothedBlendshapes={},this.skinMaterials=[],this.currentSkinColor=null,this.skinTones=[{name:"Light",color:"#FFE0BD"},{name:"Fair",color:"#FFCD94"},{name:"Medium",color:"#EAC086"},{name:"Olive",color:"#C68642"},{name:"Tan",color:"#8D5524"},{name:"Brown",color:"#6B4423"},{name:"Dark",color:"#3C241A"},{name:"Deep",color:"#2C1810"}]}getModelsBasePath(){return"undefined"!=typeof window&&window.beastsideFiltersConfig&&window.beastsideFiltersConfig.modelsPath?window.beastsideFiltersConfig.modelsPath:"/assets/models/"}getModelPath(e){return this.modelsBasePath+e}lerp(e,t,s){return e+(t-e)*(1-s)}applyDeadzone(e,t,s){return Math.abs(t-e)<s?e:t}async initialize(){try{await this.loadCharacter(0),this.setupEventListeners(),this.generateAllThumbnails()}catch(e){this.createPlaceholderCharacter()}}async generateAllThumbnails(){for(let t=0;t<this.characters.length;t++){const s=this.characters[t];if(!s.thumbnail)try{const e=this.getModelPath(s.path),i=await this.thumbnailGenerator.generateThumbnail(e);i&&(s.thumbnail=i,this.events.emit("thumbnailGenerated",{index:t,character:s,thumbnail:i}))}catch(e){}}this.events.emit("allThumbnailsGenerated",{characters:this.characters})}getThumbnail(e){return e>=0&&e<this.characters.length?this.characters[e].thumbnail:null}createPlaceholderCharacter(){const e=new re;e.name="PlaceholderCharacter";const t=new g(.5,32,32),s=new q({color:16767916,roughness:.7,metalness:.1}),i=new p(t,s);e.add(i);const r=new g(.08,16,16),n=new q({color:0}),a=new p(r,n);a.position.set(-.15,.1,.4),e.add(a);const o=new p(r,n.clone());o.position.set(.15,.1,.4),e.add(o);const h=new Se(.15,.03,16,32,Math.PI),c=new q({color:9109504}),l=new p(h,c);l.position.set(0,-.15,.4),l.rotation.x=Math.PI,e.add(l),this.placeholderParts={head:i,leftEye:a,rightEye:o,mouth:l},this.currentModel=e,this.scene.add(e)}async loadCharacter(e){if(e<0||e>=this.characters.length)throw new Error(`Invalid character index: ${e}`);const t=this.characters[e];if(t.loaded&&t.model)this.switchToCharacter(e);else{this.isLoading=!0,this.loadingProgress=0;try{const s=this.getModelPath(t.path),i=await this.loadGLTF(s);t.model=i.scene,t.loaded=!0,this.findMorphTargetMeshes(i.scene),this.validateMorphTargets(),this.switchToCharacter(e),this.events.emit("characterLoaded",{index:e,character:t})}catch(s){throw s}finally{this.isLoading=!1,this.loadingProgress=100}}}loadGLTF(e){return new Promise((t,s)=>{this.loader.load(e,e=>t(e),e=>{e.lengthComputable&&(this.loadingProgress=e.loaded/e.total*100)},e=>s(e))})}findMorphTargetMeshes(e){this.morphTargetMeshes=[],e.traverse(e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0),e.isMesh&&e.morphTargetDictionary&&e.morphTargetInfluences&&this.morphTargetMeshes.push(e)}),this.findSkinMaterials(e)}findSkinMaterials(e){this.skinMaterials=[];const t=["skin","body","face","head","arm","hand","leg","neck","torso","flesh"];e.traverse(e=>{if(e.isMesh&&e.material){const s=(e.name||"").toLowerCase(),i=(e.material.name||"").toLowerCase();if(t.some(e=>s.includes(e)||i.includes(e))){(Array.isArray(e.material)?e.material:[e.material]).forEach(e=>{e&&!this.skinMaterials.includes(e)&&(this.skinMaterials.push(e),e.userData.originalColor=e.color?e.color.clone():null)})}}}),0===this.skinMaterials.length&&this.findSkinMaterialsByColor(e)}findSkinMaterialsByColor(e){e.traverse(e=>{if(e.isMesh&&e.material){(Array.isArray(e.material)?e.material:[e.material]).forEach(e=>{if(e&&e.color&&!this.skinMaterials.includes(e)){const t=e.color.r,s=e.color.g,i=e.color.b;t>.5&&t>s&&s>i&&t-i>.1&&s>.3&&(this.skinMaterials.push(e),e.userData.originalColor=e.color.clone())}})}})}setSkinColor(e){if(0===this.skinMaterials.length)return!1;const t=new d(e);return this.currentSkinColor=e,this.skinMaterials.forEach(e=>{e.color&&(e.color.copy(t),e.needsUpdate=!0)}),this.events.emit("skinColorChanged",{color:e}),!0}resetSkinColor(){this.skinMaterials.forEach(e=>{e.userData.originalColor&&e.color&&(e.color.copy(e.userData.originalColor),e.needsUpdate=!0)}),this.currentSkinColor=null,this.events.emit("skinColorChanged",{color:null})}getSkinTones(){return this.skinTones}getCurrentSkinColor(){return this.currentSkinColor}validateMorphTargets(){if(0===this.morphTargetMeshes.length)return!1;const e=this.morphTargetMeshes[0],t=Object.keys(e.morphTargetDictionary),s=["eyeBlinkLeft","eyeBlinkRight","jawOpen","mouthSmileLeft"].filter(e=>!t.includes(e));return s.length,this.availableMorphTargets=t,0===s.length}switchToCharacter(e){this.currentModel&&this.scene.remove(this.currentModel);const t=this.currentSkinColor,s=this.characters[e];this.currentModel=s.model,this.currentCharacterIndex=e,this.currentModel&&(this.currentModel.rotation.y=this.modelConfig.baseRotationY,this.scene.add(this.currentModel),this.findSkinMaterials(this.currentModel),t&&this.setSkinColor(t))}setupEventListeners(){this.events.on("faceTracked",e=>{this.updateCharacter(e.blendshapes,e.transform)})}updateCharacter(e,t){this.currentModel&&(this.updateTransform(t),this.updateMorphTargets(e))}updateTransform(e){if(!this.currentModel||!e)return;const{position:t,rotation:s,scale:i}=e,r=this.modelConfig,n=(r.mirrorX?-t.x:t.x)*r.positionScale*r.positionScaleX+r.positionOffsetX,a=t.y*r.positionScale*r.positionScaleY+r.positionOffsetY,o=t.z+r.positionOffsetZ,h=r.mirrorX?-s.yaw:s.yaw,c=s.pitch*r.rotationScale*r.pitchScale+r.pitchOffset,l=h*r.rotationScale*r.yawScale+r.yawOffset,d=s.roll*r.rotationScale*r.rollScale+r.rollOffset,u=r.scaleBase+i*r.scaleMultiplier,m=r.scaleMin||.1,p=r.scaleMax||50,g=Math.max(m,Math.min(u,p)),f=r.positionDeadzone||.01,v=r.rotationDeadzone||.02,w=this.applyDeadzone(this.smoothedTransform.position.x,n,f),y=this.applyDeadzone(this.smoothedTransform.position.y,a,f),T=this.applyDeadzone(this.smoothedTransform.position.z,o,f),R=this.applyDeadzone(this.smoothedTransform.rotation.pitch,c,v),S=this.applyDeadzone(this.smoothedTransform.rotation.yaw,l,v),E=this.applyDeadzone(this.smoothedTransform.rotation.roll,d,v),A=r.positionSmoothing,b=r.rotationSmoothing,x=r.scaleSmoothing;this.smoothedTransform.position.x=this.lerp(this.smoothedTransform.position.x,w,A),this.smoothedTransform.position.y=this.lerp(this.smoothedTransform.position.y,y,A),this.smoothedTransform.position.z=this.lerp(this.smoothedTransform.position.z,T,A),this.smoothedTransform.rotation.pitch=this.lerp(this.smoothedTransform.rotation.pitch,R,b),this.smoothedTransform.rotation.yaw=this.lerp(this.smoothedTransform.rotation.yaw,S,b),this.smoothedTransform.rotation.roll=this.lerp(this.smoothedTransform.rotation.roll,E,b),this.smoothedTransform.scale=this.lerp(this.smoothedTransform.scale,g,x),this.currentModel.position.set(this.smoothedTransform.position.x,this.smoothedTransform.position.y,this.smoothedTransform.position.z),this.currentModel.rotation.order="YXZ",this.currentModel.rotation.set(r.baseRotationX+this.smoothedTransform.rotation.pitch,r.baseRotationY+this.smoothedTransform.rotation.yaw,r.baseRotationZ+this.smoothedTransform.rotation.roll);const C=this.smoothedTransform.scale;this.currentModel.scale.set(C*r.scaleX,C*r.scaleY,C*r.scaleZ)}updateMorphTargets(e){if(!e)return;if("PlaceholderCharacter"===this.currentModel.name)return void this.animatePlaceholder(e);if(!this._blendshapeDebugLogged){this._blendshapeDebugLogged=!0;const t=Object.keys(e);if(this.morphTargetMeshes.length>0){const e=Object.keys(this.morphTargetMeshes[0].morphTargetDictionary);t.filter(t=>e.includes(t)),t.filter(t=>!e.includes(t)),e.filter(e=>!t.includes(e))}}const t=this.modelConfig.blendshapeSmoothing,s=this.modelConfig.eyeSmoothing||t,i=this.modelConfig.blendshapeDeadzone||.03,r=this.modelConfig.eyeDeadzone||.06;this.morphTargetMeshes.forEach(n=>{const a=n.morphTargetDictionary,o=n.morphTargetInfluences;Object.keys(e).forEach(n=>{const h=e[n],c=this.blendshapeNameMap[n]||n,l=a[c];if(void 0!==l&&void 0!==o[l]){const e=n.toLowerCase().includes("eye")||n.toLowerCase().includes("blink"),a=e?s:t,c=e?r:i;void 0===this.smoothedBlendshapes[n]&&(this.smoothedBlendshapes[n]=0);const d=this.smoothedBlendshapes[n],u=this.applyDeadzone(d,h,c);this.smoothedBlendshapes[n]=this.lerp(d,u,a),o[l]=this.smoothedBlendshapes[n]}})})}animatePlaceholder(e){if(!this.placeholderParts)return;const{leftEye:t,rightEye:s,mouth:i}=this.placeholderParts,r=e.eyeBlinkLeft||0,n=e.eyeBlinkRight||0;t.scale.y=1-.8*r,s.scale.y=1-.8*n;const a=(e.mouthSmileLeft+e.mouthSmileRight)/2||0,o=e.jawOpen||0;i.scale.set(1+.5*a,1+2*o,1),i.position.y=.05*a-.15-.1*o}async preloadAllCharacters(){for(let t=0;t<this.characters.length;t++)if(!this.characters[t].loaded)try{await this.loadCharacter(t)}catch(e){}}getCurrentCharacter(){return this.characters[this.currentCharacterIndex]}getAllCharacters(){return this.characters}async nextCharacter(){const e=(this.currentCharacterIndex+1)%this.characters.length;await this.switchToCharacterByIndex(e)}async previousCharacter(){const e=(this.currentCharacterIndex-1+this.characters.length)%this.characters.length;await this.switchToCharacterByIndex(e)}async switchToCharacterByIndex(e){if(!(e<0||e>=this.characters.length)&&e!==this.currentCharacterIndex){this.events.emit("characterSwitching",{from:this.currentCharacterIndex,to:e});try{this.characters[e].loaded?this.switchToCharacter(e):await this.loadCharacter(e),this.events.emit("characterSwitched",{index:e,character:this.characters[e]})}catch(t){this.events.emit("characterSwitchError",{index:e,error:t})}}}dispose(){this.currentModel&&this.scene.remove(this.currentModel),this.characters.forEach(e=>{e.model&&e.model.traverse(e=>{e.isMesh&&(e.geometry.dispose(),e.material.dispose&&e.material.dispose())})}),this.thumbnailGenerator&&this.thumbnailGenerator.dispose()}}class Lt{constructor(e,t){this.container=e,this.events=t,this.touchStartX=0,this.touchStartY=0,this.touchEndX=0,this.touchEndY=0,this.isSwiping=!1,this.swipeThreshold=50,this.isUIVisible=!0,this.isTransitioning=!1,this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}initialize(){this.container.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.container.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),this.container.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.container.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.container.addEventListener("mouseup",this.handleMouseUp.bind(this)),document.addEventListener("keydown",this.handleKeyDown)}handleTouchStart(e){"BUTTON"!==e.target.tagName&&(this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.isSwiping=!0)}handleTouchMove(e){if(!this.isSwiping)return;this.touchEndX=e.touches[0].clientX,this.touchEndY=e.touches[0].clientY;Math.abs(this.touchEndX-this.touchStartX)>Math.abs(this.touchEndY-this.touchStartY)&&e.preventDefault()}handleTouchEnd(e){if(!this.isSwiping)return;this.isSwiping=!1;const t=this.touchEndX-this.touchStartX,s=this.touchEndY-this.touchStartY;Math.abs(t)>Math.abs(s)&&Math.abs(t)>this.swipeThreshold&&(t>0?this.handleSwipeRight():this.handleSwipeLeft()),this.touchStartX=0,this.touchStartY=0,this.touchEndX=0,this.touchEndY=0}handleMouseDown(e){"BUTTON"!==e.target.tagName&&(this.touchStartX=e.clientX,this.touchStartY=e.clientY,this.isSwiping=!0)}handleMouseMove(e){this.isSwiping&&(this.touchEndX=e.clientX,this.touchEndY=e.clientY)}handleMouseUp(e){if(!this.isSwiping)return;this.isSwiping=!1;const t=this.touchEndX-this.touchStartX,s=this.touchEndY-this.touchStartY;Math.abs(t)>Math.abs(s)&&Math.abs(t)>this.swipeThreshold&&(t>0?this.handleSwipeRight():this.handleSwipeLeft()),this.touchStartX=0,this.touchStartY=0,this.touchEndX=0,this.touchEndY=0}handleKeyDown(e){switch(e.key){case"ArrowLeft":e.preventDefault(),this.handleSwipeRight();break;case"ArrowRight":e.preventDefault(),this.handleSwipeLeft();break;case"1":case"2":case"3":case"4":case"5":const t=parseInt(e.key)-1;this.switchToCharacter(t);break;case"h":this.toggleUI()}}handleSwipeLeft(){this.isTransitioning||this.events.emit("characterNext")}handleSwipeRight(){this.isTransitioning||this.events.emit("characterPrevious")}switchToCharacter(e){this.isTransitioning||this.events.emit("characterSwitch",{index:e})}setTransitioning(e){this.isTransitioning=e}toggleUI(){this.isUIVisible=!this.isUIVisible,this.events.emit("uiToggle",{visible:this.isUIVisible})}showMessage(e,t=2e3){let s=this.container.querySelector(".ui-message");s||(s=document.createElement("div"),s.className="ui-message",this.container.querySelector(".filter-container").appendChild(s)),s.textContent=e,s.style.display="block",setTimeout(()=>{s.style.display="none"},t)}dispose(){this.container.removeEventListener("touchstart",this.handleTouchStart),this.container.removeEventListener("touchmove",this.handleTouchMove),this.container.removeEventListener("touchend",this.handleTouchEnd),document.removeEventListener("keydown",this.handleKeyDown)}}class kt{constructor(e,t,s){this.canvas=e,this.video=t,this.events=s,this.isRecording=!1,this.mediaRecorder=null,this.recordedChunks=[],this.recordingStartTime=0,this.maxRecordingDuration=3e4,this.lastCapturedPhoto=null,this.lastCapturedVideo=null,this.audioStream=null,this.compositeCanvas=null,this.compositeCtx=null,this.compositeAnimationId=null}async initialize(){this.compositeCanvas=document.createElement("canvas"),this.compositeCtx=this.compositeCanvas.getContext("2d");try{this.audioStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1})}catch(e){}}drawCompositeFrame(){const e=this.video.videoWidth||this.canvas.width||640,t=this.video.videoHeight||this.canvas.height||480;this.compositeCanvas.width===e&&this.compositeCanvas.height===t||(this.compositeCanvas.width=e,this.compositeCanvas.height=t),this.compositeCtx.clearRect(0,0,e,t),this.video.readyState>=2&&(this.compositeCtx.save(),this.compositeCtx.translate(e,0),this.compositeCtx.scale(-1,1),this.compositeCtx.drawImage(this.video,0,0,e,t),this.compositeCtx.restore()),this.canvas.clientWidth||this.canvas.width,this.canvas.clientHeight||this.canvas.height,this.compositeCtx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,e,t)}startCompositeLoop(){const e=()=>{this.isRecording&&(this.drawCompositeFrame(),this.compositeAnimationId=requestAnimationFrame(e))};e()}stopCompositeLoop(){this.compositeAnimationId&&(cancelAnimationFrame(this.compositeAnimationId),this.compositeAnimationId=null)}capturePhoto(){try{this.drawCompositeFrame(),this.compositeCanvas.toBlob(e=>{if(!e)throw new Error("Failed to capture canvas");this.lastCapturedPhoto={blob:e,url:URL.createObjectURL(e),timestamp:Date.now(),filename:`beastside-filter-${Date.now()}.jpg`},this.events.emit("photoCaptured",this.lastCapturedPhoto)},"image/jpeg",.95)}catch(e){this.events.emit("captureError",{type:"photo",error:e})}}async startRecording(){if(!this.isRecording)try{this.drawCompositeFrame(),this.isRecording=!0,this.startCompositeLoop();const e=this.compositeCanvas.captureStream(30);let t;if(this.audioStream){const s=this.audioStream.getAudioTracks(),i=e.getVideoTracks();t=new MediaStream([...i,...s])}else t=e;const s=this.getBestMimeType();this.mediaRecorder=new MediaRecorder(t,{mimeType:s,videoBitsPerSecond:25e5}),this.mediaRecorder.ondataavailable=e=>{e.data&&e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.onstop=()=>{this.handleRecordingStop()},this.mediaRecorder.onerror=e=>{this.stopRecording(),this.events.emit("captureError",{type:"video",error:e})},this.recordedChunks=[],this.mediaRecorder.start(100),this.recordingStartTime=Date.now(),setTimeout(()=>{this.isRecording&&this.stopRecording()},this.maxRecordingDuration),this.events.emit("recordingStarted")}catch(e){this.events.emit("captureError",{type:"video",error:e})}}stopRecording(){if(this.isRecording&&this.mediaRecorder)try{this.mediaRecorder.stop(),this.isRecording=!1,this.stopCompositeLoop()}catch(e){}}handleRecordingStop(){try{const e=this.mediaRecorder.mimeType,t=new Blob(this.recordedChunks,{type:e}),s=Date.now()-this.recordingStartTime,i=this.getFileExtension(e);this.lastCapturedVideo={blob:t,url:URL.createObjectURL(t),timestamp:Date.now(),duration:s,filename:`beastside-filter-${Date.now()}.${i}`,format:i.toUpperCase()},this.events.emit("videoRecorded",this.lastCapturedVideo),this.recordedChunks=[],this.mediaRecorder=null}catch(e){this.events.emit("captureError",{type:"video",error:e})}}getBestMimeType(){const e=["video/mp4;codecs=h264,aac","video/mp4;codecs=avc1","video/mp4"],t=["video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm;codecs=h264,opus","video/webm"];for(const s of e)if(MediaRecorder.isTypeSupported(s))return s;for(const s of t)if(MediaRecorder.isTypeSupported(s))return s;return""}getFileExtension(e){return e.startsWith("video/mp4")?"mp4":"webm"}downloadPhoto(e=this.lastCapturedPhoto){if(!e)return;const t=document.createElement("a");t.href=e.url,t.download=e.filename,t.click(),this.events.emit("photoDownloaded",e)}downloadVideo(e=this.lastCapturedVideo){if(!e)return;const t=document.createElement("a");t.href=e.url,t.download=e.filename,t.click(),this.events.emit("videoDownloaded",e)}async sharePhoto(e=this.lastCapturedPhoto){if(e)if(navigator.share)try{const t=new File([e.blob],e.filename,{type:"image/jpeg"});await navigator.share({title:"BEASTSIDE Filter",text:"Check out my BEASTSIDE character!",files:[t]}),this.events.emit("photoShared",e)}catch(t){"AbortError"===t.name||this.downloadPhoto(e)}else this.downloadPhoto(e)}async shareVideo(e=this.lastCapturedVideo){if(e)if(navigator.share)try{const t="MP4"===e.format?"video/mp4":e.blob.type||"video/webm",s=new File([e.blob],e.filename,{type:t});await navigator.share({title:"BEASTSIDE Filter",text:"Check out my BEASTSIDE character!",files:[s]}),this.events.emit("videoShared",e)}catch(t){"AbortError"===t.name||this.downloadVideo(e)}else this.downloadVideo(e)}getRecordingDuration(){return this.isRecording?Date.now()-this.recordingStartTime:0}getIsRecording(){return this.isRecording}dispose(){this.isRecording&&this.stopRecording(),this.audioStream&&(this.audioStream.getTracks().forEach(e=>e.stop()),this.audioStream=null),this.lastCapturedPhoto&&URL.revokeObjectURL(this.lastCapturedPhoto.url),this.lastCapturedVideo&&URL.revokeObjectURL(this.lastCapturedVideo.url)}}class Pt{constructor(){this.events={}}on(e,t){return this.events[e]||(this.events[e]=[]),this.events[e].push(t),()=>{this.off(e,t)}}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(e=>e!==t))}emit(e,t){this.events[e]&&this.events[e].forEach(e=>{try{e(t)}catch(s){}})}once(e,t){const s=i=>{t(i),this.off(e,s)};this.on(e,s)}clear(e){e?delete this.events[e]:this.events={}}listenerCount(e){var t;return(null==(t=this.events[e])?void 0:t.length)||0}}class _t{constructor(e){this.events=e,this.ERROR_TYPES={CAMERA_PERMISSION:"camera_permission",CAMERA_IN_USE:"camera_in_use",CAMERA_NOT_FOUND:"camera_not_found",BROWSER_UNSUPPORTED:"browser_unsupported",WEBGL_UNSUPPORTED:"webgl_unsupported",FACE_TRACKING_FAILED:"face_tracking_failed",MODEL_LOAD_FAILED:"model_load_failed",CAPTURE_FAILED:"capture_failed",NETWORK_ERROR:"network_error",STORAGE_FULL:"storage_full",PERFORMANCE_CRITICAL:"performance_critical",UNKNOWN:"unknown"},this.ERROR_MESSAGES={[this.ERROR_TYPES.CAMERA_PERMISSION]:{title:"Camera Access Required",message:"Please enable camera access in your browser settings to use BEASTSIDE Filters.",action:"Open Settings",retryable:!1},[this.ERROR_TYPES.CAMERA_IN_USE]:{title:"Camera In Use",message:"Your camera is being used by another application. Please close other apps and try again.",action:"Retry",retryable:!0},[this.ERROR_TYPES.CAMERA_NOT_FOUND]:{title:"No Camera Found",message:"No camera detected on your device. Please connect a camera and try again.",action:"Retry",retryable:!0},[this.ERROR_TYPES.BROWSER_UNSUPPORTED]:{title:"Browser Not Supported",message:"Your browser doesn't support this feature. Please use the latest Chrome, Safari, or Firefox.",action:"Learn More",retryable:!1},[this.ERROR_TYPES.WEBGL_UNSUPPORTED]:{title:"WebGL Not Available",message:"3D graphics are not supported on your device or browser. Please try a different browser.",action:"Learn More",retryable:!1},[this.ERROR_TYPES.FACE_TRACKING_FAILED]:{title:"Face Tracking Failed",message:"Unable to track your face. Make sure your face is visible and well-lit.",action:"Retry",retryable:!0},[this.ERROR_TYPES.MODEL_LOAD_FAILED]:{title:"Character Load Failed",message:"Failed to load character model. Please check your connection and try again.",action:"Retry",retryable:!0},[this.ERROR_TYPES.CAPTURE_FAILED]:{title:"Capture Failed",message:"Failed to capture photo/video. Please try again.",action:"Retry",retryable:!0},[this.ERROR_TYPES.NETWORK_ERROR]:{title:"Connection Error",message:"Unable to connect to the server. Please check your internet connection.",action:"Retry",retryable:!0},[this.ERROR_TYPES.STORAGE_FULL]:{title:"Storage Full",message:"Your device storage is full. Please free up space and try again.",action:"OK",retryable:!1},[this.ERROR_TYPES.PERFORMANCE_CRITICAL]:{title:"Low Performance",message:"Performance is too low for smooth operation. Try closing other apps or using a more powerful device.",action:"Continue Anyway",retryable:!1},[this.ERROR_TYPES.UNKNOWN]:{title:"Something Went Wrong",message:"An unexpected error occurred. Please try again.",action:"Retry",retryable:!0}},this.retryCount={},this.maxRetries=3}handle(e,t={}){const s=this.categorizeError(e,t),i=this.ERROR_MESSAGES[s];return this.events.emit("error",{type:s,error:e,context:t,info:i,canRetry:i.retryable&&this.canRetry(s)}),{type:s,...i}}categorizeError(e,t){return"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?this.ERROR_TYPES.CAMERA_PERMISSION:"NotReadableError"===e.name||"TrackStartError"===e.name?this.ERROR_TYPES.CAMERA_IN_USE:"NotFoundError"===e.name||"DevicesNotFoundError"===e.name?this.ERROR_TYPES.CAMERA_NOT_FOUND:"webgl"===t.type?this.ERROR_TYPES.WEBGL_UNSUPPORTED:"browser"===t.type?this.ERROR_TYPES.BROWSER_UNSUPPORTED:"face_tracking"===t.type?this.ERROR_TYPES.FACE_TRACKING_FAILED:"model_load"===t.type?this.ERROR_TYPES.MODEL_LOAD_FAILED:"capture"===t.type||"photo"===t.type||"video"===t.type?this.ERROR_TYPES.CAPTURE_FAILED:"NetworkError"!==e.name&&navigator.onLine?"QuotaExceededError"===e.name?this.ERROR_TYPES.STORAGE_FULL:"performance"===t.type?this.ERROR_TYPES.PERFORMANCE_CRITICAL:this.ERROR_TYPES.UNKNOWN:this.ERROR_TYPES.NETWORK_ERROR}canRetry(e){return(this.retryCount[e]||0)<this.maxRetries}incrementRetry(e){this.retryCount[e]=(this.retryCount[e]||0)+1}resetRetry(e){this.retryCount[e]=0}getRetryCount(e){return this.retryCount[e]||0}checkBrowserCompatibility(){const e=[];navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||e.push({type:this.ERROR_TYPES.BROWSER_UNSUPPORTED,feature:"getUserMedia",message:"Camera access not supported"});const t=document.createElement("canvas");return t.getContext("webgl")||t.getContext("experimental-webgl")||e.push({type:this.ERROR_TYPES.WEBGL_UNSUPPORTED,feature:"WebGL",message:"3D graphics not supported"}),"undefined"==typeof MediaRecorder&&e.push({type:this.ERROR_TYPES.BROWSER_UNSUPPORTED,feature:"MediaRecorder",message:"Video recording not supported"}),e}isBrowserSupported(){return 0===this.checkBrowserCompatibility().length}getErrorMessage(e,t={}){const s=this.categorizeError(e,t);return this.ERROR_MESSAGES[s]}logError(e,t={}){this.categorizeError(e,t)}}class It{constructor(e){this.events=e,this.targetFPS=30,this.warningFPS=20,this.criticalFPS=15,this.frameCount=0,this.lastTime=performance.now(),this.currentFPS=0,this.fpsHistory=[],this.maxHistoryLength=60,this.isMonitoring=!1,this.performanceLevel="good",this.consecutiveLowFPS=0,this.lowFPSThreshold=3,this.memorySupported=void 0!==performance.memory,this.lastMemoryCheck=0,this.memoryCheckInterval=5e3,this.rafId=null}start(){this.isMonitoring||(this.isMonitoring=!0,this.lastTime=performance.now(),this.frameCount=0,this.monitorFrame())}stop(){this.isMonitoring&&(this.isMonitoring=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null))}monitorFrame(){if(!this.isMonitoring)return;this.frameCount++;const e=performance.now(),t=e-this.lastTime;t>=1e3&&(this.currentFPS=Math.round(1e3*this.frameCount/t),this.fpsHistory.push(this.currentFPS),this.fpsHistory.length>this.maxHistoryLength&&this.fpsHistory.shift(),this.checkPerformance(),this.events.emit("performanceUpdate",{fps:this.currentFPS,level:this.performanceLevel,avgFPS:this.getAverageFPS()}),this.frameCount=0,this.lastTime=e),this.memorySupported&&e-this.lastMemoryCheck>this.memoryCheckInterval&&(this.checkMemory(),this.lastMemoryCheck=e),this.rafId=requestAnimationFrame(()=>this.monitorFrame())}checkPerformance(){const e=this.performanceLevel;this.currentFPS>=this.targetFPS?(this.performanceLevel="good",this.consecutiveLowFPS=0):this.currentFPS>=this.warningFPS?(this.performanceLevel="warning",this.consecutiveLowFPS++):(this.performanceLevel="critical",this.consecutiveLowFPS++),e!==this.performanceLevel&&this.events.emit("performanceLevelChange",{level:this.performanceLevel,fps:this.currentFPS,threshold:this.getThresholdForLevel(this.performanceLevel)}),this.consecutiveLowFPS>=this.lowFPSThreshold&&"critical"===this.performanceLevel&&this.events.emit("performanceCritical",{fps:this.currentFPS,avgFPS:this.getAverageFPS(),consecutiveCount:this.consecutiveLowFPS})}checkMemory(){if(!this.memorySupported)return;const e=performance.memory,t=e.usedJSHeapSize/1024/1024,s=e.jsHeapSizeLimit/1024/1024,i=t/s*100;i>80&&this.events.emit("memoryWarning",{usedMB:Math.round(t),limitMB:Math.round(s),percentage:Math.round(i)})}getAverageFPS(){if(0===this.fpsHistory.length)return 0;const e=this.fpsHistory.reduce((e,t)=>e+t,0);return Math.round(e/this.fpsHistory.length)}getMinFPS(){return 0===this.fpsHistory.length?0:Math.min(...this.fpsHistory)}getMaxFPS(){return 0===this.fpsHistory.length?0:Math.max(...this.fpsHistory)}getThresholdForLevel(e){switch(e){case"good":default:return this.targetFPS;case"warning":return this.warningFPS;case"critical":return this.criticalFPS}}getStats(){return{fps:this.currentFPS,avgFPS:this.getAverageFPS(),minFPS:this.getMinFPS(),maxFPS:this.getMaxFPS(),level:this.performanceLevel,history:[...this.fpsHistory]}}isPerformanceAcceptable(){return"critical"!==this.performanceLevel&&this.currentFPS>=this.warningFPS}reset(){this.fpsHistory=[],this.consecutiveLowFPS=0,this.performanceLevel="good"}}class Ot{constructor(e){this.root=e,this.state={initialized:!1,cameraActive:!1,renderingActive:!1,faceTracking:!1,faceDetected:!1,currentCharacter:0,totalCharacters:5,fps:0,isRecording:!1,error:null},this.events=new Pt,this.errorHandler=new _t(this.events),this.performanceMonitor=new It(this.events),this.cameraManager=null,this.renderer=null,this.faceTracker=null,this.characterManager=null,this.uiController=null,this.mediaCapture=null}async init(){try{const e=this.errorHandler.checkBrowserCompatibility();if(e.length>0){const t=new Error("Browser not supported");throw t.compatibilityErrors=e,t}this.createContainerStructure(),await this.initializeModules(),await this.start(),this.performanceMonitor.start(),this.state.initialized=!0}catch(e){this.handleError(e,{type:"initialization"})}}createContainerStructure(){this.root.innerHTML='\n            <div class="filter-container">\n                <div class="loading-overlay" id="loading-overlay">\n                    <div class="loading-content">\n                        <div class="loading-spinner"></div>\n                        <div class="loading-text">Initializing camera...</div>\n                        <div class="loading-subtext">Please allow camera access when prompted</div>\n                    </div>\n                </div>\n                <div class="video-container">\n                    <video id="camera-video" autoplay playsinline></video>\n                    <canvas id="filter-canvas"></canvas>\n                </div>\n                <div class="controls">\n                    <button id="close-btn" class="btn-close" aria-label="Close filter">\n                        <i data-lucide="x"></i>\n                    </button>\n                </div>\n                <div class="capture-controls">\n                    <button id="photo-btn" class="btn-capture btn-photo" title="Take Photo" aria-label="Take photo">\n                        <i data-lucide="camera"></i>\n                    </button>\n                    <button id="video-btn" class="btn-capture btn-video" title="Record Video" aria-label="Record video">\n                        <i data-lucide="video"></i>\n                    </button>\n                    <button id="stop-btn" class="btn-capture btn-stop" style="display: none;" title="Stop Recording" aria-label="Stop recording">\n                        <i data-lucide="square"></i>\n                    </button>\n                    <div class="recording-timer" style="display: none;" aria-live="polite" aria-atomic="true">00:00</div>\n                </div>\n                <div class="debug-info">\n                    <div id="fps-counter">FPS: --</div>\n                    <div id="face-status">Face: Searching...</div>\n                </div>\n                <div class="character-indicator" role="navigation" aria-label="Character selection">\n                    <div class="character-dots" role="tablist" aria-label="Characters">\n                        \x3c!-- Dots generated dynamically based on available characters --\x3e\n                    </div>\n                    <div class="character-name" aria-live="polite"></div>\n                    <div class="swipe-hint" aria-hidden="true"> Swipe to switch </div>\n                </div>\n                <div class="skin-color-picker">\n                    <button class="skin-picker-toggle" title="Change Skin Color" aria-label="Change skin color" aria-expanded="false" aria-controls="skin-picker-panel">\n                        <i data-lucide="palette"></i>\n                    </button>\n                    <div id="skin-picker-panel" class="skin-picker-panel" style="display: none;" role="dialog" aria-label="Skin color picker">\n                        <div class="skin-picker-header">\n                            <span id="skin-picker-title">Skin Tone</span>\n                            <button class="skin-reset-btn" title="Reset to Original" aria-label="Reset skin color to original">\n                                <i data-lucide="undo-2"></i>\n                            </button>\n                        </div>\n                        <div class="skin-tones" role="group" aria-labelledby="skin-picker-title"></div>\n                    </div>\n                </div>\n                <div class="error-message" style="display: none;"></div>\n                <div class="preview-modal" style="display: none;" role="dialog" aria-label="Media preview" aria-modal="true">\n                    <div class="preview-content">\n                        <button class="preview-close" aria-label="Close preview"><i data-lucide="x"></i></button>\n                        <img class="preview-image" style="display: none;" alt="Captured photo preview" />\n                        <video class="preview-video" style="display: none;" controls autoplay loop muted aria-label="Captured video preview"></video>\n                        <div class="preview-actions">\n                            <button class="btn-preview btn-download" aria-label="Download media"><i data-lucide="download"></i> Download</button>\n                            <button class="btn-preview btn-share" aria-label="Share media"><i data-lucide="share-2"></i> Share</button>\n                            <button class="btn-preview btn-retake" aria-label="Close and retake"><i data-lucide="refresh-cw"></i> Retake</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',this.videoElement=this.root.querySelector("#camera-video"),this.canvasElement=this.root.querySelector("#filter-canvas"),this.errorElement=this.root.querySelector(".error-message"),this.fpsCounter=this.root.querySelector("#fps-counter"),this.faceStatus=this.root.querySelector("#face-status"),this.characterDotsContainer=this.root.querySelector(".character-dots"),this.characterDots=[],this.characterName=this.root.querySelector(".character-name"),this.loadingOverlay=this.root.querySelector("#loading-overlay"),this.loadingText=this.root.querySelector(".loading-text"),this.loadingSubtext=this.root.querySelector(".loading-subtext"),this.photoBtn=this.root.querySelector("#photo-btn"),this.videoBtn=this.root.querySelector("#video-btn"),this.stopBtn=this.root.querySelector("#stop-btn"),this.recordingTimer=this.root.querySelector(".recording-timer"),this.previewModal=this.root.querySelector(".preview-modal"),this.previewImage=this.root.querySelector(".preview-image"),this.previewVideo=this.root.querySelector(".preview-video"),this.previewClose=this.root.querySelector(".preview-close"),this.downloadBtn=this.root.querySelector(".btn-download"),this.shareBtn=this.root.querySelector(".btn-share"),this.retakeBtn=this.root.querySelector(".btn-retake"),this.skinPickerToggle=this.root.querySelector(".skin-picker-toggle"),this.skinPickerPanel=this.root.querySelector(".skin-picker-panel"),this.skinTonesContainer=this.root.querySelector(".skin-tones"),this.skinResetBtn=this.root.querySelector(".skin-reset-btn"),this.skinPickerToggle.addEventListener("click",()=>{this.toggleSkinPicker()}),this.skinResetBtn.addEventListener("click",()=>{var e;null==(e=this.characterManager)||e.resetSkinColor(),this.updateSkinToneSelection(null)}),document.addEventListener("click",e=>{e.target.closest(".skin-color-picker")||(this.skinPickerPanel.style.display="none",this.skinPickerToggle.setAttribute("aria-expanded","false"))}),this.photoBtn.addEventListener("click",()=>this.handlePhotoCapture()),this.videoBtn.addEventListener("click",()=>this.handleVideoStart()),this.stopBtn.addEventListener("click",()=>this.handleVideoStop()),this.previewClose.addEventListener("click",()=>this.closePreview()),this.retakeBtn.addEventListener("click",()=>this.closePreview()),this.downloadBtn.addEventListener("click",()=>this.handleDownload()),this.shareBtn.addEventListener("click",()=>this.handleShare()),window.lucide&&window.lucide.createIcons(),this.debugInfo=this.root.querySelector(".debug-info"),window.location.search.includes("debug")&&this.debugInfo.classList.add("visible"),document.addEventListener("keydown",e=>{"d"!==e.key.toLowerCase()||e.target.matches("input, textarea")||this.debugInfo.classList.toggle("visible")})}async initializeModules(){this.updateLoadingText("Setting up camera...","Please allow camera access when prompted"),this.cameraManager=new be(this.videoElement),this.updateLoadingText("Initializing 3D engine...",""),this.renderer=new xe(this.canvasElement,this.events),this.updateLoadingText("Loading character...","This may take a moment"),this.characterManager=new Mt(this.renderer.scene,this.events),await this.characterManager.initialize(),this.populateCharacterDots(),this.events.on("thumbnailGenerated",e=>{this.updateCharacterDotThumbnail(e.index,e.thumbnail)}),this.updateLoadingText("Starting face tracking...","Almost ready!"),this.faceTracker=new Me(this.videoElement,this.events),this.uiController=new Lt(this.root,this.events),this.uiController.initialize(),this.mediaCapture=new kt(this.canvasElement,this.videoElement,this.events),await this.mediaCapture.initialize(),this.setupEventHandlers()}setupEventHandlers(){this.events.on("faceDetected",e=>{this.state.faceDetected=e.detected,this.faceStatus&&(this.faceStatus.textContent=e.detected?"Face:  Tracking":"Face: Searching...",this.faceStatus.style.color=e.detected?"#4ade80":"#fbbf24")}),this.events.on("faceTracked",e=>{this.state.faceTracking=!0}),this.events.on("fpsUpdate",e=>{this.state.fps=e.fps,this.fpsCounter&&(this.fpsCounter.textContent=`FPS: ${e.fps}`,e.fps>=30?this.fpsCounter.style.color="#4ade80":e.fps>=20?this.fpsCounter.style.color="#fbbf24":this.fpsCounter.style.color="#ef4444"),e.fps}),this.events.on("characterNext",async()=>{this.uiController.setTransitioning(!0),await this.characterManager.nextCharacter(),this.uiController.setTransitioning(!1)}),this.events.on("characterPrevious",async()=>{this.uiController.setTransitioning(!0),await this.characterManager.previousCharacter(),this.uiController.setTransitioning(!1)}),this.events.on("characterSwitch",async e=>{this.uiController.setTransitioning(!0),await this.characterManager.switchToCharacterByIndex(e.index),this.uiController.setTransitioning(!1)}),this.events.on("characterSwitched",e=>{this.state.currentCharacter=e.index,this.updateCharacterIndicator(e.index),this.characterName&&(this.characterName.textContent=e.character.name)}),this.events.on("characterSwitching",e=>{}),this.events.on("photoCaptured",e=>{this.showPreview("photo",e)}),this.events.on("videoRecorded",e=>{this.showPreview("video",e)}),this.events.on("recordingStarted",()=>{this.state.isRecording=!0,this.updateRecordingUI(!0),this.startRecordingTimer()}),this.events.on("captureError",e=>{this.handleError(e.error,{type:e.type})}),this.events.on("performanceUpdate",e=>{this.state.fps=e.fps}),this.events.on("performanceLevelChange",e=>{this.fpsCounter&&("good"===e.level?this.fpsCounter.style.color="#4ade80":"warning"===e.level?this.fpsCounter.style.color="#fbbf24":this.fpsCounter.style.color="#ef4444")}),this.events.on("performanceCritical",e=>{this.uiController&&this.uiController.showMessage(` Low performance detected (${e.fps} FPS). Try closing other apps.`,5e3)}),this.events.on("memoryWarning",e=>{}),this.events.on("error",e=>{})}updateCharacterIndicator(e){this.characterDots&&this.characterDots.forEach((t,s)=>{s===e?(t.classList.add("active"),t.setAttribute("aria-selected","true")):(t.classList.remove("active"),t.setAttribute("aria-selected","false"))})}async start(){this.updateLoadingText("Starting camera...",""),await this.cameraManager.start(),this.state.cameraActive=!0,this.renderer.start(),this.state.renderingActive=!0,this.updateLoadingText("Starting face tracking...","Look at the camera"),await this.faceTracker.start(),this.state.faceTracking=!0,this.hideLoading()}handleError(e,t={}){this.state.error=e;const s=this.errorHandler.handle(e,t);this.showError(s),this.errorHandler.logError(e,t)}showError(e){if(!this.errorElement)return;const t=`\n            <div class="error-content">\n                <div class="error-icon"><i data-lucide="alert-triangle"></i></div>\n                <h3 class="error-title">${e.title}</h3>\n                <p class="error-message">${e.message}</p>\n                ${e.retryable&&!1!==e.canRetry?'<button class="error-retry-btn"><i data-lucide="refresh-cw"></i> Retry</button>':'<button class="error-close-btn"><i data-lucide="x"></i> Close</button>'}\n            </div>\n        `;this.errorElement.innerHTML=t,this.errorElement.style.display="flex",window.lucide&&window.lucide.createIcons({attrs:{class:"lucide-icon"}});const s=this.errorElement.querySelector(".error-retry-btn");s&&s.addEventListener("click",async()=>{this.hideError(),this.errorHandler.incrementRetry(e.type);try{e.type.includes("camera")?await this.cameraManager.start():await this.init()}catch(t){this.handleError(t,{type:"retry"})}});const i=this.errorElement.querySelector(".error-close-btn");i&&i.addEventListener("click",()=>{this.hideError()})}hideError(){this.errorElement&&(this.errorElement.style.display="none",this.errorElement.innerHTML="")}handlePhotoCapture(){this.state.isRecording||this.mediaCapture.capturePhoto()}async handleVideoStart(){await this.mediaCapture.startRecording()}handleVideoStop(){this.mediaCapture.stopRecording(),this.state.isRecording=!1,this.updateRecordingUI(!1),this.stopRecordingTimer()}updateRecordingUI(e){e?(this.videoBtn.style.display="none",this.stopBtn.style.display="block",this.recordingTimer.style.display="block",this.photoBtn.disabled=!0,this.photoBtn.style.opacity="0.5"):(this.videoBtn.style.display="block",this.stopBtn.style.display="none",this.recordingTimer.style.display="none",this.photoBtn.disabled=!1,this.photoBtn.style.opacity="1")}startRecordingTimer(){this.recordingTimerInterval=setInterval(()=>{const e=this.mediaCapture.getRecordingDuration(),t=Math.floor(e/1e3),s=Math.floor(t/60),i=t%60;this.recordingTimer.textContent=`${String(s).padStart(2,"0")}:${String(i).padStart(2,"0")}`},100)}stopRecordingTimer(){this.recordingTimerInterval&&(clearInterval(this.recordingTimerInterval),this.recordingTimerInterval=null),this.recordingTimer.textContent="00:00"}showPreview(e,t){this.currentPreviewType=e,this.currentPreviewMedia=t,"photo"===e?(this.previewImage.src=t.url,this.previewImage.style.display="block",this.previewVideo.style.display="none"):(this.previewVideo.src=t.url,this.previewVideo.style.display="block",this.previewImage.style.display="none"),this.previewModal.style.display="flex"}closePreview(){this.previewModal.style.display="none",this.previewImage.src="",this.previewVideo.src="",this.currentPreviewType=null,this.currentPreviewMedia=null}handleDownload(){"photo"===this.currentPreviewType?this.mediaCapture.downloadPhoto(this.currentPreviewMedia):this.mediaCapture.downloadVideo(this.currentPreviewMedia),this.closePreview()}async handleShare(){"photo"===this.currentPreviewType?await this.mediaCapture.sharePhoto(this.currentPreviewMedia):await this.mediaCapture.shareVideo(this.currentPreviewMedia)}populateCharacterDots(){if(!this.characterManager||!this.characterDotsContainer)return;const e=this.characterManager.getAllCharacters();this.characterDotsContainer.innerHTML="",e.forEach((e,t)=>{const s=document.createElement("button");if(s.className="dot"+(0===t?" active":""),s.dataset.index=t,s.dataset.name=e.name,s.setAttribute("role","tab"),s.setAttribute("aria-selected",0===t?"true":"false"),s.setAttribute("aria-label",e.name),e.thumbnail){const t=document.createElement("img");t.src=e.thumbnail,t.alt=e.name,t.draggable=!1,s.appendChild(t)}else{const t=this.getCharacterInitials(e.name);s.textContent=t}s.addEventListener("click",()=>{this.events.emit("characterSwitch",{index:t})}),this.characterDotsContainer.appendChild(s)}),this.characterDots=this.characterDotsContainer.querySelectorAll(".dot"),e.length>0&&(this.characterName.textContent=e[0].name),e.length<=1&&(this.characterDotsContainer.style.display="none",this.root.querySelector(".swipe-hint").style.display="none")}updateCharacterDotThumbnail(e,t){if(!this.characterDots||e>=this.characterDots.length)return;const s=this.characterDots[e];if(s&&t){s.textContent="";const i=document.createElement("img");i.src=t,i.alt=s.dataset.name||`Character ${e+1}`,i.draggable=!1,s.appendChild(i)}}getCharacterInitials(e){const t=e.charAt(0).toUpperCase(),s=e.match(/\d+/);return t+(s?s[0]:"")}updateLoadingText(e,t=""){this.loadingText&&(this.loadingText.textContent=e),this.loadingSubtext&&(this.loadingSubtext.textContent=t)}hideLoading(){this.loadingOverlay&&this.loadingOverlay.classList.add("hidden")}showLoading(e="Loading...",t=""){this.loadingOverlay&&(this.loadingOverlay.classList.remove("hidden"),this.updateLoadingText(e,t))}toggleSkinPicker(){const e="none"!==this.skinPickerPanel.style.display;this.skinPickerPanel.style.display=e?"none":"block",this.skinPickerToggle.setAttribute("aria-expanded",!e),e||0!==this.skinTonesContainer.children.length||this.populateSkinTones()}populateSkinTones(){if(!this.characterManager)return;const e=this.characterManager.getSkinTones();this.skinTonesContainer.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.className="skin-swatch",t.style.backgroundColor=e.color,t.title=e.name,t.dataset.color=e.color,t.addEventListener("click",()=>{this.characterManager.setSkinColor(e.color),this.updateSkinToneSelection(e.color)}),this.skinTonesContainer.appendChild(t)});const t=document.createElement("label");t.className="skin-custom",t.innerHTML='\n            <input type="color" class="skin-custom-input" value="#EAC086" title="Custom Color">\n            <span class="skin-custom-icon"><i data-lucide="pipette"></i></span>\n        ',this.skinTonesContainer.appendChild(t);t.querySelector(".skin-custom-input").addEventListener("input",e=>{this.characterManager.setSkinColor(e.target.value),this.updateSkinToneSelection(e.target.value)}),window.lucide&&window.lucide.createIcons()}updateSkinToneSelection(e){this.skinTonesContainer.querySelectorAll(".skin-swatch").forEach(t=>{t.dataset.color===e?t.classList.add("selected"):t.classList.remove("selected")})}destroy(){this.performanceMonitor&&this.performanceMonitor.stop(),this.mediaCapture&&this.mediaCapture.dispose(),this.uiController&&this.uiController.dispose(),this.faceTracker&&this.faceTracker.stop(),this.characterManager&&this.characterManager.dispose(),this.cameraManager&&this.cameraManager.stop(),this.renderer&&this.renderer.stop(),this.stopRecordingTimer(),this.events.clear(),this.state.initialized=!1}}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("beastside-filters-root");if(!e)return;new Ot(e).init()});
